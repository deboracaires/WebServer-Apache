<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat WebSocket</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chat {
            height: 75vh;
            overflow-y: scroll;
            text-align: left;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        hr {
            background-color: black;
        }

        video {
            width: 80vw;
        }
    </style>
</head>

<body class="bg-gray-800 m-0 p-0 w-screen h-screen flex text-white">
    <section id="room" class="w-full flex flex-col p-4 gap-6">
        <div id="chat" class="bg-gray-700 p-4 mb-4 rounded-2xl"></div>

        <div class="flex w-full justify-center gap-4">
            <input type="text" id="mensagem" placeholder="Digite sua mensagem"
                class="w-full p-4 bg-gray-600 rounded-2xl placeholder-gray-200">
            <button id="enviar" onclick="enviarMensagem()"
                class="w-24 bg-blue-500 font-bold p-4 rounded-lg hover:bg-blue-700">
                Enviar
            </button>
        </div>

        <div class="w-full flex justify-end gap-4">
            <input type="file" id="videoInput" accept="video/*">

            <div id="video-container"></div>

            <button id="enviarVideo" onclick="enviarVideo()"
                class="bg-blue-500 font-bold p-4 rounded-lg hover:bg-blue-700">
                Enviar Vídeo
            </button>
        </div>
    </section>

    <div class="h-screen border-l border-gray-700"></div>

    <section class="w-80 p-6 gap-2 flex flex-col">
        <button onclick="logout()" class="bg-blue-500 font-bold w-full p-4 rounded-lg hover:bg-blue-700">
            Sair do chat
        </button>
        <p class="text-lg font-bold ">Membros do chat</p>
        <ul id="members" class="text-lg">
        </ul>
    </section>
</body>

<script>
    const nomeUsuario = prompt("Digite seu nome de usuário:");

    if (!nomeUsuario) {
        alert("Nome de usuário é obrigatório. Recarregue a página e insira um nome.");
        throw new Error("Nome de usuário não fornecido.");
    }

    const socket = new WebSocket("ws://localhost:8765");
    const chatDiv = document.getElementById("chat");
    const membersList = document.getElementById("members");
    const videoContainer = document.getElementById("video-container");
    const videoInput = document.getElementById("videoInput");

    socket.onopen = () => {
        // Enviar o nome de usuário ao servidor quando a conexão é estabelecida
        socket.send(nomeUsuario);
    };

    socket.onmessage = (event) => {
        const mensagem = event.data;
        console.log(mensagem)

        if (mensagem.startsWith("STATUS:")) {
            const listaMembros = mensagem.replace('STATUS:', '');
            const membros = JSON.parse(listaMembros);

            if (membros) {
                membersList.innerHTML = '';
                membros.forEach(membro => {
                    const novoMembro = document.createElement("li");
                    novoMembro.textContent = `${membro['nome_usuario']} - ${membro['status']}`;

                    membersList.appendChild(novoMembro);
                });
            }
        } else if (mensagem.startsWith("VIDEO:")) {
            exibirVideo(nomeUsuario, mensagem.substring(6));
        }
        else {
            const mensagemRecebida = document.createElement("p");
            mensagemRecebida.textContent = mensagem;
            chatDiv.appendChild(mensagemRecebida);
        }
    };

    function enviarMensagem() {
        const mensagemInput = document.getElementById("mensagem");
        const mensagem = mensagemInput.value;

        if (mensagem.trim() !== "") {
            socket.send(`${mensagem}`);
            mensagemInput.value = "";
        }
    }

    function enviarVideo() {
        const file = videoInput.files[0];

        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                const videoData = reader.result.split(",")[1]; // Remover o prefixo "data:video/*;base64,"
                socket.send(`VIDEO:${videoData}`);
            };
            reader.readAsDataURL(file);
        } else {
            alert("Por favor, selecione um vídeo antes de enviar.");
        }
    }

    function exibirVideo(nomeRemetente, videoData) {
        // Criar uma mensagem formatada para exibir no chat
        const mensagemVideo = document.createElement("p");
        mensagemVideo.innerHTML = `${nomeRemetente}: <br>`;

        // Criar um elemento de vídeo e configurá-lo
        const video = document.createElement("video");
        video.controls = true;
        video.style.width = "80vw";
        video.style.height = "40vh";
        video.style.marginTop = "0";

        // Converter os dados base64 para Blob e criar a URL do vídeo
        const blob = b64toBlob(videoData, "video/mp4");
        const videoURL = URL.createObjectURL(blob);

        video.src = videoURL;

        // Adicionar o vídeo à mensagem
        mensagemVideo.appendChild(video);

        // Adicionar a mensagem ao contêiner do chat
        chatDiv.appendChild(mensagemVideo);
    }

    // Função auxiliar para converter base64 para Blob
    function b64toBlob(base64, contentType = "") {
        const sliceSize = 1024;
        const byteCharacters = atob(base64);
        const byteArrays = [];

        for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
            const slice = byteCharacters.slice(offset, offset + sliceSize);
            const byteNumbers = new Array(slice.length);

            for (let i = 0; i < slice.length; i++) {
                byteNumbers[i] = slice.charCodeAt(i);
            }

            const byteArray = new Uint8Array(byteNumbers);
            byteArrays.push(byteArray);
        }

        return new Blob(byteArrays, { type: contentType });
    }

    function login() {
        return (
            `
            <h1>Hello world</h1>
            `
        )
    }

    function logout() {
        console.log('logout')
        socket.close();
        const body = document.querySelector('body');
        body.innerHTML = login();
    }
</script>

</html>